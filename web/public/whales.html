<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Whale Watch · Block Buster</title>
    <link rel="stylesheet" href="css/tailwind.min.css?v=20260205">
    <link rel="stylesheet" href="dashboard.css?v=20260205">
    <script src="runtime-config.js?v=20260205"></script>
    <script src="js/utils.js?v=20260205"></script>
    <script src="js/shell.js?v=20260205"></script>
    <script src="js/nav.js?v=20260205"></script>
    <script src="js/walkthrough.js?v=20260205"></script>
</head>
<body class="font-display min-h-screen relative">
    <a href="#main-content" class="sr-only">Skip to content</a>
    <main id="main-content" class="page-content space-y-5">
        <div class="flex items-center justify-between mb-2" id="breadcrumb">
            <div class="flex items-center gap-2 text-xs text-gray-300">
                <span class="text-gray-400">Analyze</span><span class="text-gray-500">/</span><span>Whale Watch</span>
                <span id="whale-pill" class="status-pill status-warn" aria-live="polite">PENDING</span>
                <span id="whale-schema" class="micro-badge">schema —</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="whale-lag" class="micro-badge">lag —</span>
            <span id="whale-errors" class="micro-badge">errs —</span>
            <span id="whale-updated" class="chip" aria-live="polite">Waiting for data</span>
        </div>
    </div>

    <section class="panel-blade space-y-3" id="whale-panel">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="whale-metrics">
            <div class="panel-blade">
                <div class="text-xs text-gray-400 uppercase">Top Provider</div>
                <div id="whale-top" class="text-2xl font-semibold">—</div>
                <div class="text-xs text-gray-500" id="whale-top-market">—</div>
            </div>
            <div class="panel-blade">
                <div class="text-xs text-gray-400 uppercase">Total Volume (BLOCK)</div>
                <div id="whale-volume" class="text-2xl font-semibold">—</div>
                <div class="text-xs text-gray-500">Last 100 blocks</div>
            </div>
            <div class="panel-blade">
                <div class="text-xs text-gray-400 uppercase">Active Providers</div>
                <div id="whale-count" class="text-2xl font-semibold">—</div>
                <div class="text-xs text-gray-500">All markets</div>
            </div>
        </div>

        <div class="panel-blade">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-300">Live Whale Trades</h2>
                    <span class="micro-badge" id="whale-source">/whales —</span>
                    <span class="micro-badge" id="whale-schema-chip">manifest —</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="whale-retry" class="micro-badge">Retry</button>
                    <span class="chip text-xs" id="whale-stream-stamp">Waiting…</span>
                </div>
            </div>
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full text-left text-sm sticky-header">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="pb-2">Provider</th>
                            <th class="pb-2">Market</th>
                            <th class="pb-2">Volume (BLOCK)</th>
                            <th class="pb-2">Receipts</th>
                            <th class="pb-2">Updated</th>
                        </tr>
                    </thead>
                    <tbody id="whale-table">
                        <tr><td colspan="5" class="py-3 text-center text-gray-500">Loading…</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="space-y-3 md:hidden" id="whale-accordion">
                <div class="accordion-card">
                    <div class="text-center text-gray-500">Loading…</div>
                </div>
            </div>
        </div>
    </section>
    <div id="error-drawer" class="panel-blade p-4 mt-4 hidden" aria-live="polite">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-gray-300">Recent Errors</h3>
            <div class="flex items-center gap-2">
                <button id="whale-error-retry" class="micro-badge">Retry</button>
                <button id="error-clear" class="micro-badge">Clear</button>
            </div>
        </div>
        <ul id="error-list" class="text-xs text-gray-400 space-y-1"></ul>
    </div>
</main>

<script src="js/utils.js?v=20260205"></script>
<script src="js/nav.js?v=20260205"></script>
<script src="js/walkthrough.js?v=20260205"></script>
<script>
    const fmtNum = (v) => Number(v || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const { apiBase } = resolveApiConfig();
    let lastUpdated = 0;
    let schemaHash = localStorage.getItem('block_buster_schema_hash') || null;
    const logError = createErrorLogger({ drawerId: 'error-drawer', listId: 'error-list', clearId: 'error-clear', retryId: 'whale-error-retry', onRetry: () => loadWhales(true) });

    function setStatus(pill, tone, label) {
        if (!pill) return;
        pill.classList.remove('status-good','status-warn','status-bad','status-info');
        pill.classList.add(`status-${tone}`);
        pill.textContent = label;
    }

    function renderWhales(items) {
        const table = document.getElementById('whale-table');
        const acc = document.getElementById('whale-accordion');
        if (!table || !acc) return;
        if (!items || !items.length) {
            table.innerHTML = `<tr><td colspan="5" class="py-3 text-center text-gray-500">No whale activity yet</td></tr>`;
            acc.innerHTML = `<div class="accordion-card"><div class="text-center text-gray-500">No whale activity yet</div></div>`;
            return;
        }
        table.innerHTML = '';
        acc.innerHTML = '';
        const top = items[0];
        document.getElementById('whale-top').textContent = top.provider_id || '—';
        document.getElementById('whale-top-market').textContent = top.market || '—';
        document.getElementById('whale-volume').textContent = fmtNum(items.reduce((s,i)=>s+(i.volume||0),0));
        document.getElementById('whale-count').textContent = fmtNum(items.length);
        items.forEach(w => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class=\"py-2\">${w.provider_id || '—'}</td>
                <td class=\"py-2 uppercase\">${w.market || '—'}</td>
                <td class=\"py-2\">${fmtNum(w.volume)} </td>
                <td class=\"py-2\">${fmtNum(w.receipts_count || w.count || 0)}</td>
                <td class=\"py-2\">${new Date(w.last_active || Date.now()).toLocaleTimeString()}</td>
            `;
            table.appendChild(tr);

            const card = document.createElement('div');
            card.className = 'accordion-card';
            card.innerHTML = `
                <div class=\"flex items-center justify-between\">
                    <div class=\"text-sm font-semibold\">${w.provider_id || '—'}</div>
                    <span class=\"chip\">${fmtNum(w.volume)} BLOCK</span>
                </div>
                <div class=\"text-xs text-gray-400\">${w.market || '—'} • ${fmtNum(w.receipts_count || w.count || 0)} receipts • ${new Date(w.last_active || Date.now()).toLocaleTimeString()}</div>
            `;
            acc.appendChild(card);
        });
        lastUpdated = Date.now();
        emitClientFlip('whales_fresh', apiBase);
        document.getElementById('whale-panel')?.classList.remove('is-stale');
        const stamp = document.getElementById('whale-updated');
        if (stamp) stamp.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        const streamStamp = document.getElementById('whale-stream-stamp');
        if (streamStamp) streamStamp.textContent = `${items.length} providers live`;
        setStatus(document.getElementById('whale-pill'), 'good', 'LIVE');
    }

    async function fetchManifest() {
        try {
            const { res, latencyMs } = await fetchWithTiming(`${apiBase}/manifest`, { cache: 'no-store' });
            if (!res.ok) return;
            const manifest = await res.json();
            if (manifest?.schema_hash) {
                setProvenanceChip('whale-schema-chip', '/manifest', latencyMs);
                const chip = document.getElementById('whale-schema');
                const prev = schemaHash;
                schemaHash = manifest.schema_hash;
                localStorage.setItem('block_buster_schema_hash', schemaHash);
                chip && (chip.textContent = `schema ${schemaHash.slice(0,8)}`);
                if (prev && prev !== schemaHash) {
                    setStatus(document.getElementById('whale-pill'), 'warn', 'SCHEMA DRIFT');
                    pushToast('Schema changed, refresh recommended', 'warn', { context: '/manifest' });
                }
            }
        } catch (e) {
            logError('/manifest', e.message || 'error');
        }
    }

    async function loadWhales(isRetry = false) {
        try {
            const { res, latencyMs } = await fetchWithTiming(`${apiBase}/whales`, { cache: 'no-store' });
            if (!res.ok) throw new Error(`whales fetch failed (${res.status})`);
            const data = await res.json();
            renderWhales(data.items || data.whales || []);
            setProvenanceChip('whale-source', '/whales', latencyMs);
        } catch (e) {
            logError('/whales', e.message || 'error');
            emitClientFlip('whales_stale', apiBase);
            document.getElementById('whale-panel')?.classList.add('is-stale');
            setStatus(document.getElementById('whale-pill'), 'warn', isRetry ? 'RETRY' : 'STALE');
        }
    }

    function connectWhalesWS() {
        try {
            const ws = new WebSocket(apiBase.replace(/^http/i,'ws') + '/whales/ws');
            ws.onmessage = (ev) => {
                try {
                    const msg = JSON.parse(ev.data);
                    renderWhales(msg.whales || msg.items || []);
                } catch (err) {
                    logError('/whales/ws', err.message || 'parse');
                }
            };
            ws.onerror = () => setStatus(document.getElementById('whale-pill'), 'warn', 'STALE');
        } catch (err) {
            logError('/whales/ws', err.message || 'error');
            setStatus(document.getElementById('whale-pill'), 'warn', 'STALE');
        }
    }

    async function fetchHealth() {
        try {
            const { res, latencyMs } = await fetchWithTiming(`${apiBase}/health`, { cache: 'no-store' });
            if (!res.ok) throw new Error('health failed');
            const data = await res.json();
            const lag = data.feature_lag_ms ?? data.feature_lag ?? latencyMs;
            document.getElementById('whale-lag').textContent = `lag ${Math.round(lag || latencyMs)}ms`;
            document.getElementById('whale-errors').textContent = `errs ${data.recent_errors ?? data.recent_error_count ?? 0}`;
            if (lag && lag > 8000) {
                markLagged('#whale-panel', true);
            } else {
                markLagged('#whale-panel', false);
            }
        } catch (e) {
            logError('/health', e.message || 'error');
        }
    }

    function checkStale() {
        const pill = document.getElementById('whale-pill');
        if (!lastUpdated) return;
        const stale = Date.now() - lastUpdated > 15000;
        document.getElementById('whale-panel')?.classList.toggle('is-stale', stale);
        if (stale) {
            setStatus(pill, 'warn', 'STALE');
            emitClientFlip('whales_stale', apiBase);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchManifest();
        loadWhales();
        connectWhalesWS();
        fetchHealth();
        setInterval(loadWhales, 15000);
        setInterval(fetchHealth, 8000);
        setInterval(checkStale, 4000);
        document.getElementById('whale-retry')?.addEventListener('click', () => loadWhales(true));
    });
</script>
<script src="js/footer.js?v=20260205"></script>
</body>
</html>
